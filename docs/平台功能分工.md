### 一、 核心架构设计理念
本平台采用“管理与执行分离” 的架构模式。

+ **Java (RuoYi-Cloud)**：作为**控制平面**。负责一切“静态”资源的管理、权限控制、上下文组装以及与用户的长连接维护。它是“大脑”的管理者。
+ **Python (Langchain)**：作为**执行平面**。负责无状态的逻辑运算、推理编排与工具执行，只对单次请求负责，不持久化业务数据。



### 二、 控制平面：RuoYi-Cloud (Java)
**核心职责**：作为业务网关与资源编排器，负责静态元数据管理与运行时上下文组装。

#### 2.1 资源配置管理
负责维护系统内所有静态元数据。

+ **插件注册中心**：
    - 管理外部 HTTP 工具（MCP）的标准协议定义（OpenAPI/JSON Schema），存储于 MySQL 数据库中。
    - 管理内部 Python 原生工具的参数定义映射（Parameter Schema），确保与 Python 代码侧参数签名对齐。
+ **模型服务管理**：
    - 配置 LLM 模型接入点（OneAPI Base URL）、计费单价及上下文窗口限制，管理 `sys_ai_model` 表。

#### 2.2 凭证安全管理
负责敏感信息的加密存储与运行时注入。

+ **密钥托管**：使用加密算法存储用户提供的第三方服务凭证（如 API Key, OAuth Token），
+ 记录于 `sys_user_credential` 表。
+ **动态解密注入**：在发起推理请求时，根据任务配置解密相关凭证，并注入至请求载荷（Payload）的 `runtime_config` 字段中。确保 Python 端仅在运行时持有凭证，且不进行持久化存储。

#### 2.3 编排与调度
负责将业务需求转换为可执行的上下文包。

+ **工作流定义**：存储 Agent 的流程编排 DSL（Domain Specific Language）。
+ **载荷组装**：聚合对话上下文（Context）、模型配置、插件 Schema 及运行时凭证，构建标准化的 JSON Payload 发送至 Python 执行引擎。

#### 2.4 网关与可观测性
作为前端与推理引擎之间的透明代理（Transparent Proxy）。

+ **SSE 流式透传**：建立 Java NIO 异步通道，接收 Python 端的 Server-Sent Events (SSE) 流，并实时转发至前端。
+ **旁路审计**：实时监听流中的特定事件（如 `tool_start`, `done`），用于操作日志记录及内容合规性审查。
+ **计量计费**：捕获流结束时的 `done` 事件，提取 `usage` 字段统计 Token 消耗，执行扣费逻辑。



### 三、执行平面：LangChain Engine (Python)  
**核心职责**：提供无状态的推理计算环境，执行逻辑运算与工具调用。

#### 3.1 推理内核
+ **图运行时（Graph Runtime）**：基于 LangGraph 解析 DSL，构建动态计算图，管理推理状态机（State Machine）。
+ **模型交互**：解析 `runtime_config` 中的模型配置，通过标准接口（如 OpenAI SDK）调用 OneAPI 服务。

#### 3.2 通用工具执行器
针对外部 HTTP 插件的通用调用模块，实现**Schema 驱动执行**。

+ **执行机制**：完全基于传入的 JSON Schema（URL, Method, Auth Config）动态构造 HTTP 请求，无需硬编码业务逻辑。
+ **鉴权映射**：根据协议中的 `auth_config` 定义，将 Payload 中的凭证自动映射至 HTTP Header 或 Query 参数中。

#### 3.3 原生能力运行时
针对高计算复杂度或需本地环境支持的功能模块。

+ **执行逻辑**：运行预定义的 Python Class（如 DeepSearch, RAG 检索逻辑）。
+ **接口规范**：通过装饰器或基类约束，确保 Python 代码的参数定义与 RuoYi 端存储的 JSON Schema 保持一致。



### 四、数据交互流程
标准请求生命周期如下：

1. **初始化**：
    - RuoYi 接收用户请求，校验权限。
    - RuoYi 检索 `sys_ai_plugin` 与 `sys_user_credential` 表，加载关联配置与加密凭证。
2. **载荷构建**：
    - RuoYi 执行解密操作，组装包含 `runtime_config`（Schema + Credentials）的完整 Payload。
    - 通过内部 HTTP 接口同步调用 Python 引擎。
3. **执行与流式响应**：
    - Python 引擎根据 Payload 初始化 Graph 并执行推理。
    - 产生中间状态（如 `tool_thinking`, `tool_start`, `message_chunk`）并通过 SSE 推送回 RuoYi。
4. **终结与结算**：
    - RuoYi 捕获流中的 `done` 事件，提取 Token 消耗数据，完成计费。
    - 关闭连接。



