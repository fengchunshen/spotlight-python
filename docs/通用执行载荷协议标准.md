### 1. 核心定义
**通用执行载荷协议标准(Payload)** 是指在一次推理请求中，由控制平面（RuoYi）组装并发送给执行平面（Python）的**自包含JSON 数据包**。

+ **自包含性**：Python 引擎执行任务所需的所有信息（包括解密后的 API Key、工具的 URL、模型的配置）都在包内，Python 侧无需反查数据库。
+ **生命周期**：仅在单次 HTTP 请求（Request-Response）周期内有效，任务结束后即被销毁，不持久化存储。



### 2. 协议结构全貌
Payload 由三大核心板块组成：**任务元数据 (Task Meta)**、**输入上下文 (Input Context)** 和 **运行时配置 (Runtime Config)**。

```java
{
  "task_meta": { ... },       // 任务身份与追踪信息
  "input": { ... },           // 对话历史与用户输入
  "runtime_config": {         // 核心：动态注入的资源与能力
      "model": { ... },       // 模型网关配置
      "tools": [ ... ],       // 插件能力定义
      "vault": { ... }        // 解密后的凭证保险箱
  }
}
```

### 3. 字段详细定义
#### 3.1 任务元数据 (Task Meta)
用于链路追踪、日志归档及回调标识。

| **<font style="color:rgb(31, 31, 31);">字段名</font>** | **<font style="color:rgb(31, 31, 31);">类型</font>** | **<font style="color:rgb(31, 31, 31);">说明</font>** | **<font style="color:rgb(31, 31, 31);">来源</font>** |
| --- | --- | --- | --- |
| `<font style="color:rgb(68, 71, 70);">workflow_id</font>` | <font style="color:rgb(31, 31, 31);">String</font> | <font style="color:rgb(31, 31, 31);">对应 LangGraph 中的工作流图谱 ID (如 </font>`<font style="color:rgb(68, 71, 70);">agent_chat</font>`<br/><font style="color:rgb(31, 31, 31);">, </font>`<font style="color:rgb(68, 71, 70);">data_analyst</font>`<br/><font style="color:rgb(31, 31, 31);">)</font> | `<font style="color:rgb(68, 71, 70);">sys_agent.workflow_id</font>` |
| `<font style="color:rgb(68, 71, 70);">trace_id</font>` | <font style="color:rgb(31, 31, 31);">String</font> | <font style="color:rgb(31, 31, 31);">全局唯一追踪 ID (UUID)，用于关联 Java 日志与 Python 日志</font> | <font style="color:rgb(31, 31, 31);">生成于 Java 网关</font> |
| `<font style="color:rgb(68, 71, 70);">user_id</font>` | <font style="color:rgb(31, 31, 31);">String</font> | <font style="color:rgb(31, 31, 31);">发起用户标识，仅用于 Python 侧打印日志或透传给工具</font> | `<font style="color:rgb(68, 71, 70);">sys_user</font>` |


#### 3.2 输入上下文 (Input Context)
包含 LLM 推理所需的业务数据。

| **<font style="color:rgb(31, 31, 31);">字段名</font>** | **<font style="color:rgb(31, 31, 31);">类型</font>** | **<font style="color:rgb(31, 31, 31);">说明</font>** | **<font style="color:rgb(31, 31, 31);">来源</font>** |
| --- | --- | --- | --- |
| `<font style="color:rgb(68, 71, 70);">messages</font>` | <font style="color:rgb(31, 31, 31);">List</font> | <font style="color:rgb(31, 31, 31);">标准 OpenAI 格式的对话历史 </font>`<font style="color:rgb(68, 71, 70);">[{"role":"user","content":"..."}]</font>` | <font style="color:rgb(31, 31, 31);">前端传参 + 历史记录查询</font> |
| `<font style="color:rgb(68, 71, 70);">variables</font>` | <font style="color:rgb(31, 31, 31);">Dict</font> | <font style="color:rgb(31, 31, 31);">工作流所需的其他全局变量 (如 </font>`<font style="color:rgb(68, 71, 70);">current_time</font>`<br/><font style="color:rgb(31, 31, 31);">, </font>`<font style="color:rgb(68, 71, 70);">file_url</font>`<br/><font style="color:rgb(31, 31, 31);">)</font> | <font style="color:rgb(31, 31, 31);">业务上下文注入</font> |


#### 3.3 运行时配置 (Runtime Config) —— **Payload 的核心**
这是 RuoYi 进行“资源编排”的产物，决定了 Python 这次任务“能用什么能力”以及“怎么用”。

**A. 模型配置 (**`**model**`**)** 告诉 Python 连接哪个 OneAPI 渠道。  

```java
"model": {
  "provider": "openai",           // 协议标准
  "model_name": "deepseek-chat",  // 实际传给 OneAPI 的模型代码
  "base_url": "http://one-api:3000/v1", // 内部网关地址
  "api_key": "sk-oneapi-token...", // 聚合后的令牌
  "temperature": 0.7
}
```



**B. 工具定义列表 (**`**tools**`**)** 包含所有**原生工具**和**扩展插件**的完整定义。  

```java
"tools": [
  {
    "type": "NATIVE",
    "name": "deep_search",
    "description": "深度搜索...",
    "parameter_schema": { ... }, // 供 LLM 学习
    "execution_config": { "class": "DeepSearchTool" } // 供 Python 反射调用
  },
  {
    "type": "HTTP",
    "name": "qichacha",
    "description": "查询企业...",
    "parameter_schema": { ... },
    "execution_config": { 
        "url": "http://api.qcc.com/...", 
        "method": "GET",
        "auth_config": { "source": "QCC_KEY", "target": "Token" } // 鉴权映射规则
    }
  }
]
```



**C. 凭证保险箱 (**`**vault**`**)最为敏感的部分**。RuoYi 从数据库取出加密串，**解密为明文**后放入此处。Python 在执行工具时，从这里取值填充到 HTTP 请求中。  

```java
"vault": {
  "QCC_KEY": "sk-88888888",      // 企查查明文 Key
  "FEISHU_TOKEN": "t-12345678"   // 飞书明文 Token
}
```

### 4. 安全与传输规范
由于 Payload 中包含明文密钥（`vault` 字段），传输过程必须严格管控。

1. **网络边界**：Payload 仅允许在**内网环境**（Kubernetes Cluster IP 或 VPC 内网）中传输。严禁将此 Payload 暴露在公网 HTTP 接口上。
2. **生命周期销毁**：Python 引擎在接收到请求后，将其加载到内存（RAM）中。请求结束后，Python 的垃圾回收机制（GC）应自动回收该对象，**严禁将 Payload 内容（特别是 **`**vault**`** 字段）打印到磁盘日志中**。
3. **传输加密**：虽然是内网，但建议 RuoYi 与 Megumi 之间的 HTTP 通道启用 mTLS（双向 TLS 认证）以防止内网嗅探。

